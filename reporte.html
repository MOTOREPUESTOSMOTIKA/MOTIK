<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial Detallado | Reportes</title>
    <link rel="stylesheet" href="style.css">
    </head>
<body class="body-reporte">
    <div class="reporte-container">
        <header class="header-reporte">
            <h1>Historial Cronol贸gico de Movimientos</h1>
            <button onclick="window.location.href='index.html'" class="btn-volver">Volver al Panel</button>
        </header>

        <div id="contenido-reporte">
            </div>
    </div>

    <script>
        function cargarReporte() {
            // 1. Obtener datos del localStorage
            const transaccionesVivas = JSON.parse(localStorage.getItem('transacciones')) || [];
            const historialCierres = JSON.parse(localStorage.getItem('historial_cierres')) || [];
            const contenedor = document.getElementById('contenido-reporte');
            contenedor.innerHTML = '';

            // --- SECCIN A: MOVIMIENTOS ACTUALES (SIN CERRAR) ---
            if (transaccionesVivas.length > 0) {
                const divActual = document.createElement('div');
                divActual.className = 'fecha-grupo periodo-actual'; 
                divActual.innerHTML = '<h2 class="fecha-titulo"> Periodo Actual (Sin cerrar)</h2>';
                
                // Reutilizamos la l贸gica de agrupaci贸n por fecha para el periodo actual
                const grupos = {};
                transaccionesVivas.forEach(t => {
                    if (!grupos[t.fecha]) grupos[t.fecha] = { ventas: [], gastos: [], balance: 0 };
                    if (t.tipo === 'ingreso') {
                        grupos[t.fecha].ventas.push(t);
                        grupos[t.fecha].balance += t.monto;
                    } else {
                        grupos[t.fecha].gastos.push(t);
                        grupos[t.fecha].balance -= t.monto;
                    }
                });

                Object.keys(grupos).sort((a, b) => new Date(b) - new Date(a)).forEach(fecha => {
                    const dia = grupos[fecha];
                    divActual.innerHTML += generarHTMLTabla(fecha, dia.ventas, dia.gastos, dia.balance);
                });
                contenedor.appendChild(divActual);
            }

            // --- SECCIN B: CIERRES DE CAJA ARCHIVADOS ---
            if (historialCierres.length > 0) {
                const tituloCierres = document.createElement('h2');
                tituloCierres.innerText = "Historial de Cajas Cerradas";
                tituloCierres.style.margin = "40px 0 20px 0";
                contenedor.appendChild(tituloCierres);

                // Mostramos los cierres del m谩s nuevo al m谩s viejo
                [...historialCierres].reverse().forEach(cierre => {
                    const divCierre = document.createElement('div');
                    divCierre.className = 'fecha-grupo caja-cerrada';
                    
                    let totalV = 0, totalG = 0;
                    cierre.movimientos.forEach(m => {
                        if(m.tipo === 'ingreso') totalV += m.monto;
                        else totalG += m.monto;
                    });

                    divCierre.innerHTML = `
                        <h2 class="fecha-titulo"> Caja Cerrada: ${cierre.fecha}</h2>
                        ${generarHTMLTabla("Resumen del Periodo", 
                            cierre.movimientos.filter(m => m.tipo === 'ingreso'), 
                            cierre.movimientos.filter(m => m.tipo === 'gasto'), 
                            (totalV - totalG)
                        )}
                    `;
                    contenedor.appendChild(divCierre);
                });
            }

            if (transaccionesVivas.length === 0 && historialCierres.length === 0) {
                contenedor.innerHTML = "<p style='text-align:center;'>No hay ning煤n registro en el sistema.</p>";
            }
        }

        // Funci贸n auxiliar para no repetir c贸digo de tablas
        function generarHTMLTabla(titulo, ventas, gastos, balance) {
            return `
                <div class="sub-bloque">
                    <h3>${titulo}</h3>
                    <div class="tablas-flex">
                        <div class="columna">
                            <h4>Ventas / Entradas</h4>
                            <table>
                                ${ventas.map(v => `<tr><td>${v.desc}</td><td class="monto-pos">+$${v.monto.toFixed(2)}</td></tr>`).join('')}
                                ${ventas.length === 0 ? '<tr><td>Sin ventas</td></tr>' : ''}
                            </table>
                        </div>
                        <div class="columna">
                            <h4>Gastos / Surtido</h4>
                            <table>
                                ${gastos.map(g => `<tr><td>${g.desc}</td><td class="monto-neg">-$${g.monto.toFixed(2)}</td></tr>`).join('')}
                                ${gastos.length === 0 ? '<tr><td>Sin gastos</td></tr>' : ''}
                            </table>
                        </div>
                    </div>
                    <div class="total-dia">
                        Resultado: <span style="color: ${balance >= 0 ? 'green' : 'red'}">$${balance.toFixed(2)}</span>
                    </div>
                </div>
                <hr>`;
        }

        window.onload = cargarReporte;
    </script>
</body>
</html>